---
description: 이 실습을 시작하기 전에, 실습 소개를 읽어 주시기 바랍니다.
---

# 1.1 설치 사전 준비

### PuTTY 설치 및 첫 번째 VM 연결 (Windows 사용하실 경우만 해당)

{% hint style="info" %}
\*참고: Mac을 사용 중이라면, 아래의 “Terminal/iTerm2를 통한 첫 번째 VM 연결 (Mac 전용)” 부분으로 이동하세요.\
Amazon VM에 연결/SSH 하기 위해 기본 제공되는 Terminal 또는 iTerm2(기본 Terminal을 대체하는 더 많은 기능을 제공하는 앱)를 사용할 수 있으므로, Windows 전용 앱인 PuTTY는 필요하지 않습니다.
{% endhint %}

Windows를 사용 중이라면 무료 텔넷/SSH 클라이언트인 PuTTY 설치를 강력히 권장합니다.\
PuTTY를 사용하면 Windows에서 가벼운 클라이언트를 통해 Amazon VM에 접속할 수 있으며, 동일한 VM에 여러 개의 명령줄 세션을 열 수 있습니다.

PuTTY 다운로드 링크: https://www.chiark.greenend.org.uk/\~sgtatham/putty/latest.html

`Windows (Intel x86)` 항목에서 `putty.exe`라는 이름의 파일을 찾으세요.

<figure><img src="../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

PuTTY는 별도의 설치 과정이 필요하지 않습니다. 다운로드한 .exe 파일을 바로 실행하면 됩니다.

PuTTY를 실행한 후, `첫 번째 Amazon VM`의 공용 IP 주소를 PuTTY에 입력하세요. 이 IP 주소는 본 실습과 함께 강사가 제공한 Cluster-IPs 스프레드시트에서 확인할 수 있습니다. 연결 유형은 SSH, 포트는 22로 설정합니다.

강사가 제공한 `첫 번째 Amazon VM`의 공용 호스트 이름을 PuTTY에 입력한 뒤, SSH 항목 옆의 + 기호를 클릭하여 옵션을 확장하고, 마지막으로 Auth를 선택하세요.

<figure><img src="../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption></figcaption></figure>



인증을 위해 개인 키 파일(Private key file) 을 선택하려면 `Browse`를 클릭하세요.\


<figure><img src="../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>



강사가 제공한 “Amazon-Private-Key.ppk” 파일을 선택하세요.

왼쪽 창에서 Colors를 클릭한 후, Select a Colour to adjust에서 Default Background를 선택하고 Blue RGB 값을 90으로 변경하세요.

<figure><img src="../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>



다음으로, Session을 클릭하고 세션 이름을 `CouchbaseXX`로 입력하여 저장하세요. 여기서 `XX`는 호스트명에서 가져온 노드 번호입니다. 그런 다음 Save를 클릭합니다.\
예를 들어, 여기서는 세션이 `Couchbase01`로 저장되고 있습니다:

<figure><img src="../.gitbook/assets/image (4) (1).png" alt=""><figcaption></figcaption></figure>



이제 `Couchbase01`을 선택(하이라이트)하고 Open을 클릭하여 이 VM에 연결합니다:

<figure><img src="../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>



성공적으로 연결하기 전에 서버의 rsa2 키에 대한 메시지가 나타나면 `Yes`를 클릭해야 합니다.

<figure><img src="../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

\
로그인에 사용할 사용자 이름은 다음과 같습니다:

Login as: ec2-user

<figure><img src="../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>





### 맥에서 Terminal/iTerm2를 통해 첫 번째 VM에 접속하기: <a href="#connecting_to_the_1st_vm_via_terminal_iterm2_mac_only" id="connecting_to_the_1st_vm_via_terminal_iterm2_mac_only"></a>

Mac Terminal을 통해 로그인하는 일반적인 방법은 다음과 같습니다.

원하는 터미널 앱을 열고 아래 명령어를 입력합니다.

.pem 키 파일의 권한을 다음과 같이 변경합니다:

```bash
chmod 400 Amazon-Private-Key2.pem
```

아래 명령어로 VM에 SSH 접속을 합니다:

```bash
ssh -i Amazon-Private-Key2.pem ec2-user@<1번 VM의 public hostname>
```

아래와 같은 메시지가 나오면 Yes라고 입력합니다:

`The authenticity of host 'ec2-198-51-100-x.compute-1.amazonaws.com (10.254.142.33)'`\
`can't be established.`\
`RSA key fingerprint is 1f:51:ae:28:bf:89:e9:d8:1f:25:5d:37:2d:7d:b8:ca:9f:f5:f1:6f.`\
`Are you sure you want to continue connecting (yes/no)? yes`

Mac에서 로그인하는 방법에 대한 공식 가이드는 다음 링크에서 확인할 수 있습니다:

[http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/)

\
또한 Mac에서는 화면 색상 설정도 가능합니다. 아래는 MacBook에서 색상 변경이 적용된 스크린샷 예시입니다.

<figure><img src="../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>



### 첫 번째 Amazon 서버 살펴보기:

방금 실행한 Couchbase 서버 VM의 사양은 다음과 같습니다.

**Amazon AMI:**

```bash
Red Hat Enterprise Linux 10 (HVM) - ami-039ad96c19a3afe90 (64-bit)
Root device type: ebs
Virtualization type: paravirtual
Amazon Instance Type: t2.large
ECUs: 3 vCPU: 2
Memory: 8.0 GiB
Storage: 20GB magnetic (Note, SSDs are available, but the labs will use magnetic storage)
Network performance: moderate
CloudWatch Monitoring: disabled
Tenancy: Shared tenancy (multi-tenant hardware)
```

{% hint style="info" %}
위의 사양은 실제 운영 환경에서 사용할 Couchbase 설치에는 충분하지 않다는 점에 유의하세요!

운영 환경에서는 최소 4\~6개의 CPU 코어와 16GB 이상의 RAM이 필요합니다. 하지만 현재 VM의 사양은 프로토타입 실습 환경에서는 충분합니다.

이 실습에서는 Red Hat Linux(RHEL)를 사용하기로 했는데, 그 이유는 RHEL이 엔터프라이즈급 서버를 대상으로 설계되어 안정적이고 높은 부하를 잘 처리하기 때문입니다. 또한 RHEL은 Couchbase 7.X Enterprise Edition에서 지원되는 운영체제 중 하나입니다.
{% endhint %}

다음은 Couchbase Server에서 지원되는 OS 플랫폼 링크입니다:

https://docs.couchbase.com/server/current/install/install-platforms.html



PuTTY 또는 Terminal 창으로 이동하여, 머신의 호스트네임을 확인하세요:

```bash
[ec2-user@ip-172-31-20-35 ~]$ hostname
ip-172-31-20-35.us-west-1.compute.internal
```

참고: 이 호스트네임은 Amazon 내부 네임 서버를 통한 내부용 해석에 사용됩니다.

이 과정에서의 모든 접속은 외부용 ec2-w-x-y-z-.amazon.com 호스트네임을 사용하게 됩니다.





root 권한으로 전환한 뒤 호스트네임을 Couchbase01로 변경하세요.

```bash
[ec2-user@ip-172-31-20-35 ~]\$ sudo -i
[root@ip-172-31-20-35 ~]\# hostnamectl set-hostname Couchbase01
[root@ip-172-31-20-35 ~]\# hostnamectl status
Static hostname: Couchbase01
Icon name: computer-vm
Chassis: vm
Machine ID: 80efbea85b654c408ee6bdf762386b7c
Boot ID: 8732f73604214f2dab2bc0d4be8738fb
Virtualization: xen
Operating System: Red Hat Enterprise Linux 8.4 (Ootpa)
CPE OS Name: cpe:/o:redhat:enterprise_linux:8.4:GA
Kernel: Linux 4.18.0-305.el8_0.x86_64
Architecture: x86-64
[root@ip-172-31-20-35 ~]\# exit
logout
[ec2-user@ip-172-31-20-35 ~]\$
```

\


그 다음, PuTTY 창을 닫고 새 창을 열어 호스트네임이 변경되었는지 확인합니다.



총 RAM과 사용 중인 RAM만 확인하세요.

(이는 VM이 실행된 시간에 따라 환경마다 다를 수 있습니다.)

```bash
[ec2-user@Couchbase01 ~]$ free -mh
```

출력:

```
               total        used        free      shared  buff/cache   available
Mem:           7.5Gi       454Mi       6.9Gi        10Mi       347Mi       7.1Gi
Swap:             0B          0B          0B
```



디스크 용량을 확인하세요:

```bash
[ec2-user@Couchbase01 ~]$ sudo fdisk -l
```

\
출력:

```bash
Disk /dev/xvda: 20 GiB, 21474836480 bytes, 41943040 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: gpt
Disk identifier: D209C89E-EA5E-4FBD-B161-B461CCE297E0

Device      Start      End  Sectors  Size Type
/dev/xvda1   2048     4095     2048    1M BIOS boot
/dev/xvda2   4096   413695   409600  200M EFI System
/dev/xvda3 413696 41943006 41529311 19.8G Linux filesystem
```



서버에서 약 20 GB 크기의 데이터 디스크가 표시되는지 확인하세요 (강사가 더 큰 용량을 할당했을 수도 있으며, “Size” 열에서 확인 가능합니다).



VM에 어떤 파일 시스템이 존재하는지도 확인하세요:

```bash
[ec2-user@Couchbase01 ~]$ df -Th
```

출력:

```
Filesystem     Type      Size  Used Avail Use% Mounted on
/dev/xvda3     xfs        20G  2.0G   18G  10% /
devtmpfs       devtmpfs  4.0M     0  4.0M   0% /dev
tmpfs          tmpfs     3.8G     0  3.8G   0% /dev/shm
tmpfs          tmpfs     1.5G  8.6M  1.5G   1% /run
tmpfs          tmpfs     1.0M     0  1.0M   0% /run/credentials/systemd-journald.service
/dev/xvda2     vfat      200M  8.4M  192M   5% /boot/efi
tmpfs          tmpfs     1.0M     0  1.0M   0% /run/credentials/serial-getty@ttyS0.service
tmpfs          tmpfs     1.0M     0  1.0M   0% /run/credentials/getty@tty1.service
tmpfs          tmpfs     768M  4.0K  768M   1% /run/user/1000
```



메인 파일 시스템은 /dev/xvda2이며, 타입은 “xfs”, 크기는 20GB, 사용 중인 공간은 1.2GB임을 확인하세요.

\


이번 실습에서는 Couchbase 데이터 파일과 인덱스 파일을 모두 이 단일 디스크에 배치할 것입니다.

그러나 운영 환경에서는 여러 디스크에 3개의 개별 볼륨을 구성하는 것이 권장됩니다:

* Linux OS용 볼륨 1개
* 데이터 파일용, 버킷당 디스크 그룹 1개
* 인덱스 파일용, 인덱스당 디스크 그룹 1개

비용 및 시간 제약으로 인해, 이번 실습에서는 이 세 가지를 모두 하나의 볼륨에 두겠습니다.





### Couchbase를 위한 모범 사례 적용:



#### 1. Swappiness 비활성화

Swappiness 수준은 Linux 가상 메모리 서브시스템이 디스크로 스왑을 얼마나 시도할지를 결정합니다. 문제는 시스템에 RAM이 충분히 있음에도 불구하고 메모리에 있는 항목을 디스크로 스왑하려고 한다는 점입니다.



현재 VM에 설정된 값을 확인하려면 다음을 실행하세요:

```
[ec2-user@Couchbase01 ~]$ cat /proc/sys/vm/swappiness
30
```

{% hint style="info" %}
기본 설정 값인 30은 다소 공격적인 편입니다. 30이라는 값은 퍼센트(%)를 의미하며, 값이 높을수록 I/O 캐시가 커지고 페이지가 더 빨리 스왑됩니다. Swappiness 값을 0으로 설정하면 성능을 향상시킬 수 있습니다. 이는 운영체제의 가상 메모리 서브시스템에 RAM의 항목을 디스크로 스왑하지 말고, 꼭 필요한 경우에만 스왑하라는 의미입니다.  만약 설정 값이 100이라면, 프로그램이 거의 즉시 디스크로 스왑되었을 것입니다. 노드의 크기를 적절히 설정했다면 스왑은 필요하지 않아야 합니다.
{% endhint %}



실행 중인 시스템에서 스와핑을 끄되, 먼저 root 사용자로 전환하세요:

```bash
[ec2-user@Couchbase01~]$ sudo -s
[root@Couchbase01 ec2-user ~] echo 0 > /proc/sys/vm/swappiness
```



그 다음, sysctl.conf 파일에서 이 변경 사항을 영구적으로 적용하여 재부팅 후에도 설정이 유지되도록 합니다 (재부팅은 하지 마세요!).

이후 root 사용자 모드를 종료하세요.

{% hint style="info" %}
이 모든 echo 명령어는 한 줄에 입력해야 하며, CMD 프롬프트에서 두 줄로 나누어 입력하지 마세요!
{% endhint %}

```bash
[root@couchbase01 ec2-user] echo '' >> /etc/sysctl.conf

[root@couchbase01 ec2-user] echo '#Set swappiness to 0 to avoid swapping' >> /etc/sysctl.conf

[root@couchbase01 ec2-user] echo 'vm.swappiness = 0' >> /etc/sysctl.conf
```





#### 2. Transparent Huge Pages 비활성화

Transparent Huge Pages(THP)는 작은 메모리 페이지를 자동으로 큰 페이지로 묶어 관리하는 리눅스 기능이지만, 데이터베이스 환경에서는 오히려 성능 저하를 유발하기 때문에 비활성화(disable) 하는 것이 일반적인 모범 사례입니다.

운영 환경의 Couchbase 클러스터에서는 각 노드에서 Transparent Huge Pages를 비활성화하는 것이 매우 중요합니다. &#x20;

(명령어는 반드시 한 줄로 입력해야 함을 기억하세요)

```
# Disable THP on a running system
[root@Couchbase01 ec2-user]  echo never > /sys/kernel/mm/transparent_hugepage/enabled
[root@Couchbase01 ec2-user]  echo never > /sys/kernel/mm/transparent_hugepage/defrag
```



